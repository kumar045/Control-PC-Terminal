#!/usr/bin/env bash
set -e

SESSION="control-terminal"
PORT=7681
INSTALL_DIR="$HOME/.control-terminal/bin"

CLOUDFLARED_BIN="cloudflared"
CLOUDFLARED_PID=""
CLOUDFLARED_LOG=""

ensure_install_dir_on_path() {
  case ":$PATH:" in
    *":$INSTALL_DIR:"*) ;;
    *) export PATH="$INSTALL_DIR:$PATH" ;;
  esac
}

download_with_retries() {
  local url="$1"
  local target="$2"
  local attempts=0

  while [ "$attempts" -lt 3 ]; do
    attempts=$((attempts + 1))
    if curl -fL --connect-timeout 10 --retry 3 --retry-delay 2 "$url" -o "$target"; then
      return 0
    fi
    echo "Download failed (attempt $attempts/3): $url"
  done

  return 1
}

# ----------------------------------------
# Cloudflared installer
# ----------------------------------------
install_cloudflared() {
  local os arch download_url target_bin
  os="$(uname -s | tr '[:upper:]' '[:lower:]')"
  arch="$(uname -m)"
  target_bin="$INSTALL_DIR/cloudflared"

  if [ "$os" != "linux" ]; then
    echo "Automatic cloudflared install is only supported on Linux."
    return 1
  fi

  case "$arch" in
    x86_64|amd64) arch="amd64" ;;
    aarch64|arm64) arch="arm64" ;;
    *)
      echo "Unsupported architecture: $arch"
      return 1
      ;;
  esac

  download_url="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-$arch"

  mkdir -p "$INSTALL_DIR"
  ensure_install_dir_on_path

  echo "Downloading cloudflared..."
  if ! download_with_retries "$download_url" "$target_bin"; then
    echo "GitHub release download failed, trying Cloudflare package mirror..."
    download_with_retries "https://pkg.cloudflare.com/cloudflared/cloudflared-linux-$arch" "$target_bin"
  fi

  chmod +x "$target_bin"

  CLOUDFLARED_BIN="$target_bin"
}

install_ttyd() {
  local os arch ttyd_file latest_tag ttyd_url target_bin

  os="$(uname -s | tr '[:upper:]' '[:lower:]')"
  arch="$(uname -m)"
  target_bin="$INSTALL_DIR/ttyd"

  if [ "$os" != "linux" ]; then
    echo "Automatic ttyd install is only supported on Linux."
    return 1
  fi

  case "$arch" in
    x86_64|amd64) ttyd_file="ttyd.x86_64" ;;
    aarch64|arm64) ttyd_file="ttyd.aarch64" ;;
    *)
      echo "Unsupported architecture: $arch"
      return 1
      ;;
  esac

  latest_tag="$(curl -fsSL https://api.github.com/repos/tsl0922/ttyd/releases/latest \
    | awk -F'"' '/"tag_name"/ {print $4; exit}')"

  if [ -z "$latest_tag" ]; then
    echo "Could not determine latest ttyd release."
    return 1
  fi

  ttyd_url="https://github.com/tsl0922/ttyd/releases/download/${latest_tag}/${ttyd_file}"

  mkdir -p "$INSTALL_DIR"
  ensure_install_dir_on_path

  echo "Downloading ttyd ($latest_tag)..."
  download_with_retries "$ttyd_url" "$target_bin"
  chmod +x "$target_bin"
}

# ----------------------------------------
# Agent auto-detection
# ----------------------------------------
detect_codex() {
  for cmd in codex openai-codex codex-cli codex-agent; do
    if command -v "$cmd" >/dev/null 2>&1; then
      echo "$cmd"
      return 0
    fi
  done
  return 1
}

detect_claude() {
  for cmd in claude claude-cli anthropic; do
    if command -v "$cmd" >/dev/null 2>&1; then
      echo "$cmd"
      return 0
    fi
  done
  return 1
}

# ----------------------------------------
# Cleanup
# ----------------------------------------
cleanup() {
  if [ -n "$CLOUDFLARED_PID" ]; then
    kill "$CLOUDFLARED_PID" >/dev/null 2>&1 || true
  fi
  if [ -n "$CLOUDFLARED_LOG" ] && [ -f "$CLOUDFLARED_LOG" ]; then
    rm -f "$CLOUDFLARED_LOG"
  fi
}
trap cleanup EXIT

# ----------------------------------------
# UI
# ----------------------------------------
echo ""
echo "Welcome to Control-Terminal ‚Äî AI Agent Launcher"
echo ""

CODEX_BIN="$(detect_codex 2>/dev/null || true)"
CLAUDE_BIN="$(detect_claude 2>/dev/null || true)"

echo "Choose which agent to run:"
echo "1) codex   ${CODEX_BIN:+($CODEX_BIN)}${CODEX_BIN:- (not installed)}"
echo "2) claude  ${CLAUDE_BIN:+($CLAUDE_BIN)}${CLAUDE_BIN:- (not installed)}"
echo "3) other"

read -p "Enter choice [1-3]: " choice

case "$choice" in
  1)
    if [ -z "$CODEX_BIN" ]; then
      echo "‚ùå Codex not found in PATH."
      exit 1
    fi
    AGENT_CMD="$CODEX_BIN"
    ;;
  2)
    if [ -z "$CLAUDE_BIN" ]; then
      echo "‚ùå Claude not found in PATH."
      exit 1
    fi
    AGENT_CMD="$CLAUDE_BIN"
    ;;
  3)
    read -p "Enter custom agent command: " AGENT_CMD
    if ! command -v "$AGENT_CMD" >/dev/null 2>&1; then
      echo "‚ùå Command '$AGENT_CMD' not found"
      exit 1
    fi
    ;;
  *)
    echo "Invalid choice"
    exit 1
    ;;
esac

echo ""
read -p "Expose terminal on a public address via Cloudflare Tunnel? (y/N): " expose_public

# ----------------------------------------
# Start tmux session
# ----------------------------------------
echo ""
echo "Starting agent '$AGENT_CMD' in tmux session..."

ensure_install_dir_on_path

tmux has-session -t "$SESSION" 2>/dev/null || \
  tmux new-session -d -s "$SESSION" "$AGENT_CMD"

# ----------------------------------------
# Cloudflare Tunnel
# ----------------------------------------
if [[ "$expose_public" =~ ^[Yy]$ ]]; then
  if ! command -v "$CLOUDFLARED_BIN" >/dev/null 2>&1; then
    echo "cloudflared not found. Installing..."
    install_cloudflared || echo "‚ö†Ô∏è Cloudflared install failed"
  fi

  if command -v "$CLOUDFLARED_BIN" >/dev/null 2>&1; then
    CLOUDFLARED_LOG="$(mktemp -t control-terminal-cloudflared.XXXXXX.log)"
    "$CLOUDFLARED_BIN" tunnel --url "http://localhost:$PORT" --no-autoupdate \
      >"$CLOUDFLARED_LOG" 2>&1 &
    CLOUDFLARED_PID=$!

    for _ in {1..30}; do
      PUBLIC_URL="$(grep -Eo 'https://[a-zA-Z0-9.-]+\.trycloudflare\.com' "$CLOUDFLARED_LOG" | head -n 1 || true)"
      if [ -n "$PUBLIC_URL" ]; then
        echo "üåç Public URL: $PUBLIC_URL"
        break
      fi
      sleep 0.5
    done

    if [ -z "$PUBLIC_URL" ]; then
      echo "‚ö†Ô∏è Tunnel started, but URL not detected yet"
      echo "Check logs: $CLOUDFLARED_LOG"
    fi
  fi
fi

# ----------------------------------------
# ttyd
# ----------------------------------------
echo ""
echo "Launching ttyd web terminal on:"
echo "üëâ http://localhost:$PORT"
echo ""

if ! command -v ttyd >/dev/null 2>&1; then
  echo "ttyd not found. Installing..."
  install_ttyd || {
    echo "‚ùå Failed to install ttyd. Run install.sh or install ttyd manually."
    exit 1
  }
fi

exec ttyd -p "$PORT" tmux attach -t "$SESSION"
